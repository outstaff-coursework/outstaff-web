{"ast":null,"code":"/*\n * Copyright The OpenTelemetry Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { propagation } from '@opentelemetry/api';\nimport { isTracingSuppressed } from '../../trace/suppress-tracing';\nimport { BAGGAGE_HEADER, BAGGAGE_ITEMS_SEPARATOR, BAGGAGE_MAX_NAME_VALUE_PAIRS, BAGGAGE_MAX_PER_NAME_VALUE_PAIRS } from '../constants';\nimport { getKeyPairs, parsePairKeyValue, serializeKeyPairs } from '../utils';\n/**\n * Propagates {@link Baggage} through Context format propagation.\n *\n * Based on the Baggage specification:\n * https://w3c.github.io/baggage/\n */\nvar W3CBaggagePropagator = /** @class */function () {\n  function W3CBaggagePropagator() {}\n  W3CBaggagePropagator.prototype.inject = function (context, carrier, setter) {\n    var baggage = propagation.getBaggage(context);\n    if (!baggage || isTracingSuppressed(context)) return;\n    var keyPairs = getKeyPairs(baggage).filter(function (pair) {\n      return pair.length <= BAGGAGE_MAX_PER_NAME_VALUE_PAIRS;\n    }).slice(0, BAGGAGE_MAX_NAME_VALUE_PAIRS);\n    var headerValue = serializeKeyPairs(keyPairs);\n    if (headerValue.length > 0) {\n      setter.set(carrier, BAGGAGE_HEADER, headerValue);\n    }\n  };\n  W3CBaggagePropagator.prototype.extract = function (context, carrier, getter) {\n    var headerValue = getter.get(carrier, BAGGAGE_HEADER);\n    var baggageString = Array.isArray(headerValue) ? headerValue.join(BAGGAGE_ITEMS_SEPARATOR) : headerValue;\n    if (!baggageString) return context;\n    var baggage = {};\n    if (baggageString.length === 0) {\n      return context;\n    }\n    var pairs = baggageString.split(BAGGAGE_ITEMS_SEPARATOR);\n    pairs.forEach(function (entry) {\n      var keyPair = parsePairKeyValue(entry);\n      if (keyPair) {\n        var baggageEntry = {\n          value: keyPair.value\n        };\n        if (keyPair.metadata) {\n          baggageEntry.metadata = keyPair.metadata;\n        }\n        baggage[keyPair.key] = baggageEntry;\n      }\n    });\n    if (Object.entries(baggage).length === 0) {\n      return context;\n    }\n    return propagation.setBaggage(context, propagation.createBaggage(baggage));\n  };\n  W3CBaggagePropagator.prototype.fields = function () {\n    return [BAGGAGE_HEADER];\n  };\n  return W3CBaggagePropagator;\n}();\nexport { W3CBaggagePropagator };","map":{"version":3,"names":["propagation","isTracingSuppressed","BAGGAGE_HEADER","BAGGAGE_ITEMS_SEPARATOR","BAGGAGE_MAX_NAME_VALUE_PAIRS","BAGGAGE_MAX_PER_NAME_VALUE_PAIRS","getKeyPairs","parsePairKeyValue","serializeKeyPairs","W3CBaggagePropagator","prototype","inject","context","carrier","setter","baggage","getBaggage","keyPairs","filter","pair","length","slice","headerValue","set","extract","getter","get","baggageString","Array","isArray","join","pairs","split","forEach","entry","keyPair","baggageEntry","value","metadata","key","Object","entries","setBaggage","createBaggage","fields"],"sources":["/home/egor/node_modules/@opentelemetry/core/src/baggage/propagation/W3CBaggagePropagator.ts"],"sourcesContent":["/*\n * Copyright The OpenTelemetry Authors\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *      https://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {\n  BaggageEntry,\n  Context,\n  propagation,\n  TextMapGetter,\n  TextMapPropagator,\n  TextMapSetter,\n} from '@opentelemetry/api';\n\nimport { isTracingSuppressed } from '../../trace/suppress-tracing';\nimport {\n  BAGGAGE_HEADER,\n  BAGGAGE_ITEMS_SEPARATOR,\n  BAGGAGE_MAX_NAME_VALUE_PAIRS,\n  BAGGAGE_MAX_PER_NAME_VALUE_PAIRS,\n} from '../constants';\nimport { getKeyPairs, parsePairKeyValue, serializeKeyPairs } from '../utils';\n\n/**\n * Propagates {@link Baggage} through Context format propagation.\n *\n * Based on the Baggage specification:\n * https://w3c.github.io/baggage/\n */\nexport class W3CBaggagePropagator implements TextMapPropagator {\n  inject(context: Context, carrier: unknown, setter: TextMapSetter): void {\n    const baggage = propagation.getBaggage(context);\n    if (!baggage || isTracingSuppressed(context)) return;\n    const keyPairs = getKeyPairs(baggage)\n      .filter((pair: string) => {\n        return pair.length <= BAGGAGE_MAX_PER_NAME_VALUE_PAIRS;\n      })\n      .slice(0, BAGGAGE_MAX_NAME_VALUE_PAIRS);\n    const headerValue = serializeKeyPairs(keyPairs);\n    if (headerValue.length > 0) {\n      setter.set(carrier, BAGGAGE_HEADER, headerValue);\n    }\n  }\n\n  extract(context: Context, carrier: unknown, getter: TextMapGetter): Context {\n    const headerValue = getter.get(carrier, BAGGAGE_HEADER);\n    const baggageString = Array.isArray(headerValue)\n      ? headerValue.join(BAGGAGE_ITEMS_SEPARATOR)\n      : headerValue;\n    if (!baggageString) return context;\n    const baggage: Record<string, BaggageEntry> = {};\n    if (baggageString.length === 0) {\n      return context;\n    }\n    const pairs = baggageString.split(BAGGAGE_ITEMS_SEPARATOR);\n    pairs.forEach(entry => {\n      const keyPair = parsePairKeyValue(entry);\n      if (keyPair) {\n        const baggageEntry: BaggageEntry = { value: keyPair.value };\n        if (keyPair.metadata) {\n          baggageEntry.metadata = keyPair.metadata;\n        }\n        baggage[keyPair.key] = baggageEntry;\n      }\n    });\n    if (Object.entries(baggage).length === 0) {\n      return context;\n    }\n    return propagation.setBaggage(context, propagation.createBaggage(baggage));\n  }\n\n  fields(): string[] {\n    return [BAGGAGE_HEADER];\n  }\n}\n"],"mappings":"AAAA;;;;;;;;;;;;;;;AAgBA,SAGEA,WAAW,QAIN,oBAAoB;AAE3B,SAASC,mBAAmB,QAAQ,8BAA8B;AAClE,SACEC,cAAc,EACdC,uBAAuB,EACvBC,4BAA4B,EAC5BC,gCAAgC,QAC3B,cAAc;AACrB,SAASC,WAAW,EAAEC,iBAAiB,EAAEC,iBAAiB,QAAQ,UAAU;AAE5E;;;;;;AAMA,IAAAC,oBAAA;EAAA,SAAAA,qBAAA,GA6CA;EA5CEA,oBAAA,CAAAC,SAAA,CAAAC,MAAM,GAAN,UAAOC,OAAgB,EAAEC,OAAgB,EAAEC,MAAqB;IAC9D,IAAMC,OAAO,GAAGf,WAAW,CAACgB,UAAU,CAACJ,OAAO,CAAC;IAC/C,IAAI,CAACG,OAAO,IAAId,mBAAmB,CAACW,OAAO,CAAC,EAAE;IAC9C,IAAMK,QAAQ,GAAGX,WAAW,CAACS,OAAO,CAAC,CAClCG,MAAM,CAAC,UAACC,IAAY;MACnB,OAAOA,IAAI,CAACC,MAAM,IAAIf,gCAAgC;IACxD,CAAC,CAAC,CACDgB,KAAK,CAAC,CAAC,EAAEjB,4BAA4B,CAAC;IACzC,IAAMkB,WAAW,GAAGd,iBAAiB,CAACS,QAAQ,CAAC;IAC/C,IAAIK,WAAW,CAACF,MAAM,GAAG,CAAC,EAAE;MAC1BN,MAAM,CAACS,GAAG,CAACV,OAAO,EAAEX,cAAc,EAAEoB,WAAW,CAAC;;EAEpD,CAAC;EAEDb,oBAAA,CAAAC,SAAA,CAAAc,OAAO,GAAP,UAAQZ,OAAgB,EAAEC,OAAgB,EAAEY,MAAqB;IAC/D,IAAMH,WAAW,GAAGG,MAAM,CAACC,GAAG,CAACb,OAAO,EAAEX,cAAc,CAAC;IACvD,IAAMyB,aAAa,GAAGC,KAAK,CAACC,OAAO,CAACP,WAAW,CAAC,GAC5CA,WAAW,CAACQ,IAAI,CAAC3B,uBAAuB,CAAC,GACzCmB,WAAW;IACf,IAAI,CAACK,aAAa,EAAE,OAAOf,OAAO;IAClC,IAAMG,OAAO,GAAiC,EAAE;IAChD,IAAIY,aAAa,CAACP,MAAM,KAAK,CAAC,EAAE;MAC9B,OAAOR,OAAO;;IAEhB,IAAMmB,KAAK,GAAGJ,aAAa,CAACK,KAAK,CAAC7B,uBAAuB,CAAC;IAC1D4B,KAAK,CAACE,OAAO,CAAC,UAAAC,KAAK;MACjB,IAAMC,OAAO,GAAG5B,iBAAiB,CAAC2B,KAAK,CAAC;MACxC,IAAIC,OAAO,EAAE;QACX,IAAMC,YAAY,GAAiB;UAAEC,KAAK,EAAEF,OAAO,CAACE;QAAK,CAAE;QAC3D,IAAIF,OAAO,CAACG,QAAQ,EAAE;UACpBF,YAAY,CAACE,QAAQ,GAAGH,OAAO,CAACG,QAAQ;;QAE1CvB,OAAO,CAACoB,OAAO,CAACI,GAAG,CAAC,GAAGH,YAAY;;IAEvC,CAAC,CAAC;IACF,IAAII,MAAM,CAACC,OAAO,CAAC1B,OAAO,CAAC,CAACK,MAAM,KAAK,CAAC,EAAE;MACxC,OAAOR,OAAO;;IAEhB,OAAOZ,WAAW,CAAC0C,UAAU,CAAC9B,OAAO,EAAEZ,WAAW,CAAC2C,aAAa,CAAC5B,OAAO,CAAC,CAAC;EAC5E,CAAC;EAEDN,oBAAA,CAAAC,SAAA,CAAAkC,MAAM,GAAN;IACE,OAAO,CAAC1C,cAAc,CAAC;EACzB,CAAC;EACH,OAAAO,oBAAC;AAAD,CAAC,CA7CD"},"metadata":{},"sourceType":"module","externalDependencies":[]}