{"ast":null,"code":"import { TransportItemType } from '../../transports';\nimport { deepEqual, getCurrentTimestamp, isNull } from '../../utils';\nexport function initializeMeasurementsAPI(_unpatchedConsole, internalLogger, config, metas, transports, tracesApi) {\n  internalLogger.debug('Initializing measurements API');\n  let lastPayload = null;\n  const pushMeasurement = function (payload) {\n    let {\n      skipDedupe,\n      context\n    } = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    var _a;\n    try {\n      const item = {\n        type: TransportItemType.MEASUREMENT,\n        payload: Object.assign(Object.assign({}, payload), {\n          trace: tracesApi.getTraceContext(),\n          timestamp: (_a = payload.timestamp) !== null && _a !== void 0 ? _a : getCurrentTimestamp(),\n          context: context !== null && context !== void 0 ? context : {}\n        }),\n        meta: metas.value\n      };\n      const testingPayload = {\n        type: item.payload.type,\n        values: item.payload.values,\n        context: item.payload.context\n      };\n      if (!skipDedupe && config.dedupe && !isNull(lastPayload) && deepEqual(testingPayload, lastPayload)) {\n        internalLogger.debug('Skipping measurement push because it is the same as the last one\\n', item.payload);\n        return;\n      }\n      lastPayload = testingPayload;\n      internalLogger.debug('Pushing measurement\\n', item);\n      transports.execute(item);\n    } catch (err) {\n      internalLogger.error('Error pushing measurement\\n', err);\n    }\n  };\n  return {\n    pushMeasurement\n  };\n}","map":{"version":3,"names":["TransportItemType","deepEqual","getCurrentTimestamp","isNull","initializeMeasurementsAPI","_unpatchedConsole","internalLogger","config","metas","transports","tracesApi","debug","lastPayload","pushMeasurement","payload","skipDedupe","context","arguments","length","undefined","item","type","MEASUREMENT","Object","assign","trace","getTraceContext","timestamp","_a","meta","value","testingPayload","values","dedupe","execute","err","error"],"sources":["/home/egor/node_modules/@grafana/faro-core/src/api/measurements/initialize.ts"],"sourcesContent":["import type { Config } from '../../config';\nimport type { InternalLogger } from '../../internalLogger';\nimport type { Metas } from '../../metas';\nimport { TransportItem, TransportItemType } from '../../transports';\nimport type { Transports } from '../../transports';\nimport type { UnpatchedConsole } from '../../unpatchedConsole';\nimport { deepEqual, getCurrentTimestamp, isNull } from '../../utils';\nimport type { TracesAPI } from '../traces';\n\nimport type { MeasurementEvent, MeasurementsAPI } from './types';\n\nexport function initializeMeasurementsAPI(\n  _unpatchedConsole: UnpatchedConsole,\n  internalLogger: InternalLogger,\n  config: Config,\n  metas: Metas,\n  transports: Transports,\n  tracesApi: TracesAPI\n): MeasurementsAPI {\n  internalLogger.debug('Initializing measurements API');\n\n  let lastPayload: Pick<MeasurementEvent, 'type' | 'values' | 'context'> | null = null;\n\n  const pushMeasurement: MeasurementsAPI['pushMeasurement'] = (payload, { skipDedupe, context } = {}) => {\n    try {\n      const item: TransportItem<MeasurementEvent> = {\n        type: TransportItemType.MEASUREMENT,\n        payload: {\n          ...payload,\n          trace: tracesApi.getTraceContext(),\n          timestamp: payload.timestamp ?? getCurrentTimestamp(),\n          context: context ?? {},\n        },\n        meta: metas.value,\n      };\n\n      const testingPayload = {\n        type: item.payload.type,\n        values: item.payload.values,\n        context: item.payload.context,\n      };\n\n      if (!skipDedupe && config.dedupe && !isNull(lastPayload) && deepEqual(testingPayload, lastPayload)) {\n        internalLogger.debug('Skipping measurement push because it is the same as the last one\\n', item.payload);\n\n        return;\n      }\n\n      lastPayload = testingPayload;\n\n      internalLogger.debug('Pushing measurement\\n', item);\n\n      transports.execute(item);\n    } catch (err) {\n      internalLogger.error('Error pushing measurement\\n', err);\n    }\n  };\n\n  return {\n    pushMeasurement,\n  };\n}\n"],"mappings":"AAGA,SAAwBA,iBAAiB,QAAQ,kBAAkB;AAGnE,SAASC,SAAS,EAAEC,mBAAmB,EAAEC,MAAM,QAAQ,aAAa;AAKpE,OAAM,SAAUC,yBAAyBA,CACvCC,iBAAmC,EACnCC,cAA8B,EAC9BC,MAAc,EACdC,KAAY,EACZC,UAAsB,EACtBC,SAAoB;EAEpBJ,cAAc,CAACK,KAAK,CAAC,+BAA+B,CAAC;EAErD,IAAIC,WAAW,GAAiE,IAAI;EAEpF,MAAMC,eAAe,GAAuC,SAAAA,CAACC,OAAO,EAAkC;IAAA,IAAhC;MAAEC,UAAU;MAAEC;IAAO,CAAE,GAAAC,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,EAAE;;IAChG,IAAI;MACF,MAAMG,IAAI,GAAoC;QAC5CC,IAAI,EAAErB,iBAAiB,CAACsB,WAAW;QACnCR,OAAO,EAAAS,MAAA,CAAAC,MAAA,CAAAD,MAAA,CAAAC,MAAA,KACFV,OAAO;UACVW,KAAK,EAAEf,SAAS,CAACgB,eAAe,EAAE;UAClCC,SAAS,EAAE,CAAAC,EAAA,GAAAd,OAAO,CAACa,SAAS,cAAAC,EAAA,cAAAA,EAAA,GAAI1B,mBAAmB,EAAE;UACrDc,OAAO,EAAEA,OAAO,aAAPA,OAAO,cAAPA,OAAO,GAAI;QAAE,EACvB;QACDa,IAAI,EAAErB,KAAK,CAACsB;OACb;MAED,MAAMC,cAAc,GAAG;QACrBV,IAAI,EAAED,IAAI,CAACN,OAAO,CAACO,IAAI;QACvBW,MAAM,EAAEZ,IAAI,CAACN,OAAO,CAACkB,MAAM;QAC3BhB,OAAO,EAAEI,IAAI,CAACN,OAAO,CAACE;OACvB;MAED,IAAI,CAACD,UAAU,IAAIR,MAAM,CAAC0B,MAAM,IAAI,CAAC9B,MAAM,CAACS,WAAW,CAAC,IAAIX,SAAS,CAAC8B,cAAc,EAAEnB,WAAW,CAAC,EAAE;QAClGN,cAAc,CAACK,KAAK,CAAC,oEAAoE,EAAES,IAAI,CAACN,OAAO,CAAC;QAExG;;MAGFF,WAAW,GAAGmB,cAAc;MAE5BzB,cAAc,CAACK,KAAK,CAAC,uBAAuB,EAAES,IAAI,CAAC;MAEnDX,UAAU,CAACyB,OAAO,CAACd,IAAI,CAAC;KACzB,CAAC,OAAOe,GAAG,EAAE;MACZ7B,cAAc,CAAC8B,KAAK,CAAC,6BAA6B,EAAED,GAAG,CAAC;;EAE5D,CAAC;EAED,OAAO;IACLtB;GACD;AACH"},"metadata":{},"sourceType":"module","externalDependencies":[]}