{"ast":null,"code":"import { dateNow, faro, genShortID } from '@grafana/faro-core';\nimport { isSampled } from './sampling';\nimport { SESSION_EXPIRATION_TIME, SESSION_INACTIVITY_TIME } from './sessionConstants';\nexport function createUserSessionObject() {\n  let {\n    sessionId,\n    isSampled = true\n  } = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n  var _a, _b;\n  const now = dateNow();\n  const generateSessionId = (_b = (_a = faro.config) === null || _a === void 0 ? void 0 : _a.sessionTracking) === null || _b === void 0 ? void 0 : _b.generateSessionId;\n  if (sessionId == null) {\n    sessionId = typeof generateSessionId === 'function' ? generateSessionId() : genShortID();\n  }\n  return {\n    sessionId,\n    lastActivity: now,\n    started: now,\n    isSampled: isSampled\n  };\n}\nexport function isUserSessionValid(session) {\n  if (session == null) {\n    return false;\n  }\n  const now = dateNow();\n  const lifetimeValid = now - session.started < SESSION_EXPIRATION_TIME;\n  if (!lifetimeValid) {\n    return false;\n  }\n  const inactivityPeriodValid = now - session.lastActivity < SESSION_INACTIVITY_TIME;\n  return inactivityPeriodValid;\n}\nexport function getUserSessionUpdater(_ref) {\n  let {\n    fetchUserSession,\n    storeUserSession\n  } = _ref;\n  return function updateSession() {\n    var _a, _b, _c, _d;\n    if (!fetchUserSession || !storeUserSession) {\n      return;\n    }\n    const sessionFromStorage = fetchUserSession();\n    if (isUserSessionValid(sessionFromStorage)) {\n      storeUserSession(Object.assign(Object.assign({}, sessionFromStorage), {\n        lastActivity: dateNow()\n      }));\n    } else {\n      let newSession = addSessionMetadataToNextSession(createUserSessionObject({\n        isSampled: isSampled()\n      }), sessionFromStorage);\n      storeUserSession(newSession);\n      (_a = faro.api) === null || _a === void 0 ? void 0 : _a.setSession(newSession.sessionMeta);\n      (_c = (_b = faro.config.sessionTracking) === null || _b === void 0 ? void 0 : _b.onSessionChange) === null || _c === void 0 ? void 0 : _c.call(_b, (_d = sessionFromStorage === null || sessionFromStorage === void 0 ? void 0 : sessionFromStorage.sessionMeta) !== null && _d !== void 0 ? _d : null, newSession.sessionMeta);\n    }\n  };\n}\nexport function addSessionMetadataToNextSession(newSession, previousSession) {\n  var _a, _b, _c, _d;\n  const sessionWithMeta = Object.assign(Object.assign({}, newSession), {\n    sessionMeta: {\n      id: newSession.sessionId,\n      attributes: Object.assign(Object.assign(Object.assign(Object.assign({}, (_b = (_a = faro.config.sessionTracking) === null || _a === void 0 ? void 0 : _a.session) === null || _b === void 0 ? void 0 : _b.attributes), (_d = (_c = faro.metas.value.session) === null || _c === void 0 ? void 0 : _c.attributes) !== null && _d !== void 0 ? _d : {}), previousSession != null ? {\n        previousSession: previousSession.sessionId\n      } : {}), {\n        isSampled: newSession.isSampled.toString()\n      })\n    }\n  });\n  return sessionWithMeta;\n}","map":{"version":3,"names":["dateNow","faro","genShortID","isSampled","SESSION_EXPIRATION_TIME","SESSION_INACTIVITY_TIME","createUserSessionObject","sessionId","arguments","length","undefined","now","generateSessionId","_b","_a","config","sessionTracking","lastActivity","started","isUserSessionValid","session","lifetimeValid","inactivityPeriodValid","getUserSessionUpdater","_ref","fetchUserSession","storeUserSession","updateSession","sessionFromStorage","Object","assign","newSession","addSessionMetadataToNextSession","api","setSession","sessionMeta","_c","onSessionChange","call","_d","previousSession","sessionWithMeta","id","attributes","metas","value","toString"],"sources":["/home/egor/node_modules/@grafana/faro-web-sdk/src/instrumentations/session/sessionManager/sessionManagerUtils.ts"],"sourcesContent":["import { dateNow, faro, genShortID } from '@grafana/faro-core';\n\nimport { isSampled } from './sampling';\nimport { SESSION_EXPIRATION_TIME, SESSION_INACTIVITY_TIME } from './sessionConstants';\nimport type { FaroUserSession } from './types';\n\ntype CreateUserSessionObjectParams = {\n  sessionId?: string;\n  isSampled?: boolean;\n};\n\nexport function createUserSessionObject({\n  sessionId,\n  isSampled = true,\n}: CreateUserSessionObjectParams = {}): FaroUserSession {\n  const now = dateNow();\n\n  const generateSessionId = faro.config?.sessionTracking?.generateSessionId;\n\n  if (sessionId == null) {\n    sessionId = typeof generateSessionId === 'function' ? generateSessionId() : genShortID();\n  }\n\n  return {\n    sessionId,\n    lastActivity: now,\n    started: now,\n    isSampled: isSampled,\n  };\n}\n\nexport function isUserSessionValid(session: FaroUserSession | null): boolean {\n  if (session == null) {\n    return false;\n  }\n\n  const now = dateNow();\n  const lifetimeValid = now - session.started < SESSION_EXPIRATION_TIME;\n\n  if (!lifetimeValid) {\n    return false;\n  }\n\n  const inactivityPeriodValid = now - session.lastActivity < SESSION_INACTIVITY_TIME;\n  return inactivityPeriodValid;\n}\n\ntype GetUserSessionUpdaterParams = {\n  storeUserSession: (session: FaroUserSession) => void;\n  fetchUserSession: () => FaroUserSession | null;\n};\n\nexport function getUserSessionUpdater({ fetchUserSession, storeUserSession }: GetUserSessionUpdaterParams): () => void {\n  return function updateSession(): void {\n    if (!fetchUserSession || !storeUserSession) {\n      return;\n    }\n\n    const sessionFromStorage = fetchUserSession();\n\n    if (isUserSessionValid(sessionFromStorage)) {\n      storeUserSession({ ...sessionFromStorage!, lastActivity: dateNow() });\n    } else {\n      let newSession = addSessionMetadataToNextSession(\n        createUserSessionObject({ isSampled: isSampled() }),\n        sessionFromStorage\n      );\n\n      storeUserSession(newSession);\n\n      faro.api?.setSession(newSession.sessionMeta);\n      faro.config.sessionTracking?.onSessionChange?.(sessionFromStorage?.sessionMeta ?? null, newSession.sessionMeta!);\n    }\n  };\n}\n\nexport function addSessionMetadataToNextSession(newSession: FaroUserSession, previousSession: FaroUserSession | null) {\n  const sessionWithMeta: Required<FaroUserSession> = {\n    ...newSession,\n    sessionMeta: {\n      id: newSession.sessionId,\n      attributes: {\n        ...faro.config.sessionTracking?.session?.attributes,\n        ...(faro.metas.value.session?.attributes ?? {}),\n        ...(previousSession != null ? { previousSession: previousSession.sessionId } : {}),\n        isSampled: newSession.isSampled.toString(),\n      },\n    },\n  };\n\n  return sessionWithMeta;\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}